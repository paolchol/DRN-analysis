---
title: "WASA input and output files import and Comparison with reservoirs observations"
author: "Paolo Colombo"
date: "2/4/2021"
output: html_document
---

# Libraries and functions

Load the libraries and functions needed and set the correct directory.

```{r libraries and functions}
setwd("C:/Users/Utente/OneDrive - Politecnico di Milano/Backup PC/Uni/Thesis/Analysis")

source("Libraries.R")
source("Functions.R")

setwd("C:/Thesis_fortran/WASA")
```

# WASA input files

## Creation of an index for the WASA input files and import them

```{r Creation of an index for the input files}
input<-list.files(path="./Input",full.names = T,recursive = TRUE)
input_index<-as.data.frame(matrix(nrow = length(input),ncol = 2))
names(input_index)<-c("path","description")
input_index$path<-input; remove(input)
for(i in 1:length(input_index$path)){
  input_index$description[i]<-readLines(input_index$path[i], n=5)[1]
}
View(input_index)

#Import the values to correctly read each file
path<-"C:/Users/Utente/OneDrive - Politecnico di Milano/Backup PC/Uni/Thesis/Analysis"
read_value<-read.table(paste0(path,"/sk_vn_sep.txt"),header = TRUE,sep = "\t")

#Creation of a list containing all the input files
#Work in progress, it needs in input all the sk, vn and sep for each file

input_files<-list()
for(i in 1:nrow(input_index)){
  name<-basename(input_index$path[i])
  if(read_value$sk[i] == "-"){
    input_files[[name]]<-c("This file is not a standard dataset")
  }else if(read_value$problem[i] == 1){
    input_files[[name]]<-c("This file has problems in the number of columns")
  }else{
    x<-read.table(input_index$path[i], skip = read_value$sk[i], sep = "\t")
    input_files[[name]]<-x
    vn<-as.numeric(read_value$vn[i])
    if(read_value$sep[i] == 1){
      col<-unlist(strsplit(readLines(input_index$path[i], n = 5)[vn], "[,]"))
    }else col<-unlist(strsplit(readLines(input_index$path[i],n = 5)[vn], " "))
    names(input_files[[name]])<-col; remove(col)
  }
}
remove(x)
```

## WASA input files visualization

```{r Input files visualization}
#Write the number of the file you would like to visualize
nfile<-16

#Look at the first 5 lines of the file
print(basename(input_index$path[nfile]))
readLines(input_index$path[nfile], n = 5)

#View the file as it has been imported in R
View(input_files[[nfile]])
```

# WASA output data

In the Output folder are stored all the output files generated by WASA.
Each file refers to a reservoir in the Cearà state, and each reservoir has an assigned code which is the code assigned to its sub-basin.
The three biggest sub-basins/reservoirs included in the Banabuiu basin are:
  - Acude Arrojado Lisboa (Banabuiu): Sub-basin ID 156
  - Acude Pedras Brancas: Sub-basin ID 123
  - Acude Fogareiro: Sub-basin ID 160
Alongside them, in the Banabuiu basin are also present:
  - Acude Pirabibu: Sub-Basin ID 147
  -	Acude Cedro: Sub-Basin ID:127
  -	Acude Patu: Sub-Basin ID: 149
  -	Acude Serafim Dias: Sub-basin ID 150
  -	Acude Cipoada: Sub-Basin ID 126
  -	Acude Poco do Barro: Sub-Basin ID 125
  -	Acude Vieirao: Sub-Basin ID 151
  -	Acude Sao Jose II: Sub-Basin ID 145
  -	Acude Quixeramobim: Sub-Basin ID 143
  -	Acude Trapia II: Sub-Basin ID 153
  -	Acude Sao José I: Sub-Basin ID 148
  -	Acude Capitao Mor: Sub-Basin ID 154
  -	Acude Monsenhor Tabosa: Sub-Basin ID 152
  -	Acude Jatoba: Sub-Basin ID 146
  -	Acude Curral Velho (Morada Nova): Sub-Basin ID 138
  -	Acude Umari: Sub-Basin ID 142

## Load Banabuiu reservoirs' names and IDs

```{r}
path<-"C:/Users/Utente/OneDrive - Politecnico di Milano/Backup PC/Uni/Thesis/Analysis"
reservoirs<-read.table(paste0(path,"/reservoir_name_ID.txt"), header = TRUE, sep = "\t")
```

## Set up the procedure to import WASA output files

Since WASA's output files are in the _.out_ format, the function needed to import them is _read.fwf_, which needs in input the positions of each column to be selected. Below this need is set up.

```{r set up for the import of WASA output files}
position<-c(0,7,13,19,25,35,45,55,68,81,91,101,111,121,131,141,155,169)
widths<-diff(position)
columns<-c("Subasin-ID", "year", "day", "hour", "qlateral(m**3/s)", "transposition(m**3/s)", "inflow(m**3/s)", "evap(m**3)", "prec(m**3)", "intake(m**3/s)", "overflow(m**3/s)", "qbottom(m**3/s)", "qout(m**3/s)", "withdrawal(m**3/s)", "elevation(m)", "area(m**2)", "volume(m**3)")

#Create a column
reservoirs$file<-paste0("./Output/res_",reservoirs$SubbasinID,"_watbal.out")
```

## Load of WASA's reservoirs' water balance output files

```{r load WASA output files}
#Create an index for WASA output files
output<-list.files(path="./Output",full.names = T,recursive = TRUE)
#View(output)

#Check if some reservoir is missing from WASA output files
check<-length(reservoirs$file)-length(output[which(output %in% reservoirs$file)])
if(check > 0){
  reservoirs$Reservoir_name[which(!(reservoirs$file %in% output))]
  print("The reservoirs above are missing from WASA's output files")
  not_present<-which(!(reservoirs$file %in% output))
}
#Morada Nova and Umari reservoirs are missing from WASA's output files

#Order the file list and names by the SubbasinID
reservoirs<-reservoirs[order(reservoirs$SubbasinID),]
row.names(reservoirs)<-NULL

#Create a list containing the WASA output files
tic("Import WASA reservoir output files")
WASA_reservoirs<-list()
for(i in 1:nrow(reservoirs)){
  name<-paste0("modres_",reservoirs$SubbasinID[i])
  if(i %in% not_present){
    WASA_reservoirs[[name]]<-"The WASA output file for this reservoir is not present"
  }else{
    WASA_reservoirs[[name]]<-read.fwf(reservoirs$file[i], widths = widths, skip = 3)
    names(WASA_reservoirs[[name]])<-columns
    #Add a column with the full date
    WASA_reservoirs[[name]]$time<-time_index(WASA_reservoirs[[name]])
  }
}
toc() # 1 min
```

## Modelled reservoirs time boundaries

Since not all reservoirs exist from the same year, and since the model is run only until a prefixed date, below the starting and ending date for each time series of the modelled reservoirs are stored in the *starts_ends_mod* dataframe.

```{r mod time boundaries}
#Creation of a dataframe containing the starting and ending date of each reservoir

starts<-data.frame(WASA_reservoirs[[1]]$time[1])
ends<-data.frame(WASA_reservoirs[[1]]$time[length(WASA_reservoirs[[1]]$time)])

for(i in 2:(length(WASA_reservoirs))){
  if(is.data.frame(WASA_reservoirs[[i]])){
    starts[i]<-as.Date(WASA_reservoirs[[i]]$time[1], format = "%Y-%m-%d")
    ends[i]<-as.Date(WASA_reservoirs[[i]]$time[length(WASA_reservoirs[[i]]$time)],
                      format = "%Y-%m-%d")    
  }else{
    starts[i]<-NA
    ends[i]<-NA
  }
}
colnames(starts)<-NULL; colnames(ends)<-NULL

starts_ends_mod<-data.frame(t(starts),t(ends));  remove(starts,ends)
names(starts_ends_mod)<-c("starts","ends")
```

# Observations
## Observations upload

Creare indice per i file nella cartella
Associargli il SubbasinsID corretto

```{r obs upload}
path<-"C:/Users/Utente/OneDrive - Politecnico di Milano/Backup PC/Uni/Thesis/Data/volume_series_banabuiu_reservoirs_ID"

obs<-data.frame(list.files(path = path, full.names = T, recursive = TRUE))
names(obs)<-"path"
obs$SubbasinID<-gsub("\\..*","",basename(obs$path))

tic("Import files of reservoir observations")
Obs_reservoirs<-list()
for(i in 1:nrow(obs)){
  name<-paste0("obsres_",obs$SubbasinID[i])
  Obs_reservoirs[[name]]<-read.csv(obs$path[i], header = TRUE, sep = ",")
}
toc() # 1 sec
```

## Observations time boundaries

```{r mod time boundaries}
#Creation of a dataframe containing the starting and ending date of each reservoir

starts<-data.frame(Obs_reservoirs[[1]]$date[1])
ends<-data.frame(Obs_reservoirs[[1]]$date[length(Obs_reservoirs[[1]]$date)])
for(i in 2:(length(Obs_reservoirs))){
  starts[i]<-as.Date(Obs_reservoirs[[i]]$date[1], format = "%Y-%m-%d")
  ends[i]<-as.Date(Obs_reservoirs[[i]]$date[length(Obs_reservoirs[[i]]$date)],
                   format = "%Y-%m-%d")
}
colnames(starts)<-NULL; colnames(ends)<-NULL

starts_ends_obs<-data.frame(t(starts),t(ends));  remove(starts,ends)
names(starts_ends_obs)<-c("starts","ends")
```

# Visual comparison between obseved and modelled reservoirs
## Creation of the dataset for visualization

```{r combining modelled and observed datasets}
#Combining modelled and observed datasets

list_mod<-WASA_reservoirs
list_obs<-Obs_reservoirs

list_comb<-list()
list_comb_vis<-list()
for(i in 1:length(list_mod)){
  if(!is.na(starts_ends_mod$starts[i])){
  index1<-which(list_mod[[i]][["time"]] == starts_ends_obs$starts[i])
  mod<-data.frame(list_mod[[i]][["volume(m**3)"]][index1:length(list_mod[[i]][["volume(m**3)"]])])
  names(mod)<-c("volume")
  index2<-which(list_obs[[i]][["date"]] == starts_ends_mod$ends[i])
  obs<-data.frame(list_obs[[i]][["volume"]][1:index2])
  names(obs)<-c("volume")
  date<-list_mod[[i]][["time"]][index1:length(list_mod[[i]][["time"]])]
  mod$id<-"Model"; mod$date<-date
  obs$id<-"Observation"; obs$date<-date
  
  #Analysis dataframe creation
  comb<-data.frame(mod,obs)
  list_comb[[i]]<-comb
  #Visualization dataframe creation
  vis_comb<- rbind.data.frame(mod,obs)
  list_comb_vis[[i]]<-vis_comb
  }else{
    list_comb[[i]]<-"Remove"
    list_comb_vis[[i]]<-"Remove"
  }
}
list_comb<-remove_list_elements(list_comb)
list_comb_vis<-remove_list_elements(list_comb_vis)

reservoir_names<-paste0("res_",reservoirs$SubbasinID[which(!is.na(starts_ends_mod$starts))])
names(list_comb)<-reservoir_names
names(list_comb_vis)<-reservoir_names
```

## Visualization of modelled and observed time series

```{r visualization of modelled and observed time series}
scaling_factor<-1000
graph_titles<-paste0(reservoirs$Reservoir_name[which(!is.na(starts_ends_mod$starts))],
                     " (",reservoir_names,")")
for(i in 1:length(list_comb_vis)){
  Legend<-list_comb_vis[[i]][["id"]]
  print(ggplot(data = list_comb_vis[[i]],
         aes(x = list_comb_vis[[i]][["date"]],
             y = list_comb_vis[[i]][["volume"]]/scaling_factor))+
        geom_line(aes(colour = Legend),size = 1)+
        labs(x = "Date", y = paste0("Volume [", scaling_factor," ",
                                parse(text='m^3'),"]"), 
              title = graph_titles[i])+
        scale_x_date(breaks = scales::breaks_width("5 years"),
               labels = scales::label_date_short())+
        scale_y_continuous(labels = scales::label_comma()))
}
```
